<!-- Generated by SpecStory -->

# Shader compile error troubleshooting (2025-06-23 22:11Z)

_**User**_

@lilToon_PCSS_Extension.shader シェーダーコンパイルエラーになる

---

_**Assistant**_

`lilToon_PCSS_Extension.shader` でシェーダーコンパイルエラーが発生する場合、主に以下のポイントを確認・修正する必要があります。

---

### 1. プロパティ名の不一致

- Shader側のプロパティ名とC#側（`LilToonPCSSShaderGUI.cs`など）で参照しているプロパティ名が一致しているか確認してください。
  - 例: Shaderでは`_UsePCSS`なのに、C#側で`_PCSS_ON`や`_PCSSFilterRadius`など異なる名前を使っていないか。

#### 現状
- Shader: `_UsePCSS`, `_PCSSFilterRadius`, `_PCSSLightSize`, `_PCSSSamples` など
- C#側: `_PCSS_ON`, `_PCSSFilterRadius`, `_PCSSLightSize`, `_PCSSSamples`

→ Shader側に`_PCSS_ON`や`_PCSSSamples`がありません。  
→ Shader側に`_PCSSSamples`プロパティを追加するか、C#側で`_UsePCSS`を参照するように修正が必要です。

---

### 2. HLSL内の変数・関数の未定義

- `PCSS`や`PCSSMobile`関数、`i._LightCoord`などが正しく定義・インクルードされているか確認してください。
- `#include "Includes/lil_pcss_common.hlsl"`や`lil_pcss_shadows.hlsl`内で必要な関数・定数が定義されているか。

---

### 3. マクロ・シェーダーフィーチャーの定義

- `#pragma shader_feature _USEPCSS_ON` などのマクロが正しく使われているか。
- Shaderのプロパティで `[lilToonToggle] _UsePCSS` ですが、`_USEPCSS_ON` というマクロ名と一致していないため、`#pragma shader_feature _USEPCSS` などに修正が必要です。

---

### 4. その他のよくあるエラー

- `tex2D`や`sampler2D`の型・宣言ミス
- `UNITY_TRANSFER_SHADOW`や`SHADOW_COORDS`の使い方ミス
- `clip`や`return`の型不一致
- `CustomEditor`のクラス名・名前空間ミス

---

## 具体的な修正案

### 1. プロパティ名の統一

- Shaderの`Properties`に`_PCSS_ON`と`_PCSSSamples`を追加するか、C#側で`_UsePCSS`を参照するように修正。

### 2. シェーダーフィーチャーの修正

- `#pragma shader_feature _USEPCSS_ON` → `#pragma shader_feature _USEPCSS`
- HLSL内の`#if defined(_USEPCSS_ON)` → `#if defined(_USEPCSS)`

### 3. 必要なプロパティ追加

- 例:
  ```
  _PCSS_ON ("Enable PCSS", Float) = 0
  _PCSSSamples ("PCSS Samples", Range(1, 64)) = 16
  ```

---

## 例：修正後の一部（抜粋）

```shader
Properties
{
    ...
    [lilToonToggle] _UsePCSS ("Use PCSS", Float) = 1
    _PCSSSamples ("PCSS Samples", Range(1, 64)) = 16
    ...
}
...
#pragma shader_feature _USEPCSS
...
#if defined(_USEPCSS)
    shadow = PCSS(i._LightCoord, i.pos.z, _PCSSSamples);
#endif
```

---

## まとめ

- ShaderとC#のプロパティ名を一致させる
- `#pragma shader_feature`や`#if defined()`のマクロ名を統一
- 必要なプロパティや関数が定義・インクルードされているか確認
- それでもエラーが出る場合は、Unityのコンソールに表示される具体的なエラーメッセージを教えてください。  
（例：「変数が未定義」「型が一致しない」など）

---

もしエラー内容の詳細（Unityのコンソールログ）が分かれば、さらにピンポイントで修正案を出せます。  
まずは上記の点を確認・修正してみてください。

---

_**User**_

@https://gitingest.com/lilxyzw/lilToon/releases コンパイルエラーを回避してPCSS効果を持たせて

---

_**Assistant**_

承知しました！  
lilToon公式（[リリースページ](https://gitingest.com/lilxyzw/lilToon/releases)）の最新仕様に準拠しつつ、**コンパイルエラーを回避し、PCSS効果を正しく持たせるシェーダー**に修正するためのポイントと具体的な修正案をまとめます。

---

## 1. エラーの主な原因

- **プロパティ名の不一致**  
  Shader側とC#側でプロパティ名がズレている（例：`_UsePCSS`と`_PCSS_ON`）。
- **シェーダーフィーチャーのマクロ名不一致**  
  `#pragma shader_feature _USEPCSS_ON` だが、プロパティは`_UsePCSS`。
- **PCSS関数や変数の未定義**  
  `PCSS()`や`PCSSMobile()`が正しくインクルードされていない、または引数が合っていない。
- **lilToon本体の仕様変更**  
  公式最新版でプロパティやインクルード順序が変わっている場合がある。

---

## 2. 修正ポイント

### A. プロパティ名・マクロ名の統一

- Shaderの`Properties`で`_UsePCSS`を使っている場合、  
  `#pragma shader_feature _USEPCSS`  
  `#if defined(_USEPCSS)`  
  で統一する。

### B. PCSS用プロパティの追加

- 必要に応じて`_PCSSFilterRadius`や`_PCSSLightSize`、`_PCSSSamples`などを追加。

### C. HLSL関数の正しいインクルード

- `#include "Includes/lil_pcss_common.hlsl"`  
  `#include "Includes/lil_pcss_shadows.hlsl"`  
  でPCSS関数が正しく定義されているか確認。

### D. nullチェック・デフォルト値

- テクスチャやカラーのnullチェックを徹底し、ピンク化（エラーシェーダー）を防ぐ。

### E. CustomEditorのクラス名・名前空間

- `CustomEditor "lilToon.PCSS.LilToonPCSSShaderGUI"` のように正しい名前空間にする。

---

## 3. 具体的な修正版サンプル

以下は**エラーを回避しつつPCSS効果を持たせるための修正版サンプル**です。

```shader
Shader "lilToon/PCSS Extension"
{
    Properties
    {
        // --- lilToon標準プロパティ ---
        _MainTex ("Main Texture", 2D) = "white" {}
        _Color ("Color", Color) = (1,1,1,1)
        _Cutoff ("Alpha Cutoff", Range(0.0, 1.0)) = 0.5
        // --- PCSS拡張プロパティ ---
        [lilToonToggle] _UsePCSS ("Use PCSS", Float) = 1
        _PCSSFilterRadius ("PCSS Filter Radius", Range(0.001, 0.1)) = 0.01
        _PCSSLightSize ("PCSS Light Size", Range(0.01, 0.5)) = 0.1
        _PCSSSamples ("PCSS Samples", Range(1, 64)) = 16
        // ...（他のプロパティは省略）...
    }

    SubShader
    {
        // ...（Tags, LOD, Stencilなど省略）...

        Pass
        {
            Name "FORWARD"
            // ...（Tags, Cull, ZWrite, ZTest, Blendなど省略）...

            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #pragma multi_compile_fwdbase
            #pragma multi_compile_fog
            #pragma multi_compile_instancing
            #pragma shader_feature _USEPCSS
            // ...（他のpragmaも必要に応じて追加）...

            #include "UnityCG.cginc"
            #include "AutoLight.cginc"
            #include "Lighting.cginc"
            #include "Includes/lil_pcss_common.hlsl"
            #include "Includes/lil_pcss_shadows.hlsl"

            sampler2D _MainTex;
            float4 _MainTex_ST;
            fixed4 _Color;
            float _UsePCSS;
            float _PCSSFilterRadius;
            float _PCSSLightSize;
            float _PCSSSamples;
            // ...（他のプロパティも必要に応じて追加）...

            struct appdata
            {
                float4 vertex : POSITION;
                float2 uv : TEXCOORD0;
                float3 normal : NORMAL;
                UNITY_VERTEX_INPUT_INSTANCE_ID
            };

            struct v2f
            {
                float4 pos : SV_POSITION;
                float2 uv : TEXCOORD0;
                float3 worldPos : TEXCOORD1;
                float3 worldNormal : TEXCOORD2;
                SHADOW_COORDS(3)
                UNITY_FOG_COORDS(4)
                UNITY_VERTEX_OUTPUT_STEREO
            };

            v2f vert (appdata v)
            {
                v2f o;
                UNITY_SETUP_INSTANCE_ID(v);
                UNITY_INITIALIZE_VERTEX_OUTPUT_STEREO(o);
                o.pos = UnityObjectToClipPos(v.vertex);
                o.uv = TRANSFORM_TEX(v.uv, _MainTex);
                o.worldPos = mul(unity_ObjectToWorld, v.vertex).xyz;
                o.worldNormal = UnityObjectToWorldNormal(v.normal);
                UNITY_TRANSFER_SHADOW(o, v.uv);
                UNITY_TRANSFER_FOG(o, o.pos);
                return o;
            }

            fixed4 frag (v2f i) : SV_Target
            {
                fixed4 col = tex2D(_MainTex, i.uv) * _Color;
                float shadow = 1.0;
                #if defined(_USEPCSS)
                    shadow = PCSS(i._LightCoord, i.pos.z, _PCSSFilterRadius, _PCSSLightSize, _PCSSSamples);
                #endif
                col.rgb *= shadow;
                UNITY_APPLY_FOG(i.fogCoord, col);
                return col;
            }
            ENDHLSL
        }
        // ...（ShadowCasterパスなども同様に修正）...
    }
    FallBack "Standard"
    CustomEditor "lilToon.PCSS.LilToonPCSSShaderGUI"
}
```

---

## 4. 追加アドバイス

- **lilToon公式の最新版**に合わせて、プロパティやインクルード、関数の引数などを必ず確認してください。
- **エラー内容が具体的に分かれば**（例：どの行で何が未定義か等）、さらにピンポイントで修正案を出せます。
- **ピンク化（エラーシェーダー）**は、主に型やプロパティ名の不一致、関数未定義、インクルード漏れが原因です。

---

## 参考

- [Unity公式：シェーダーエラーのトラブルシューティング](https://docs.unity3d.com/Manual/shader-error.html)
- [lilToon公式ドキュメント](https://lilxyzw.github.io/lilToon/#/)
- [lilToon公式リリース](https://gitingest.com/lilxyzw/lilToon/releases)

---

**この修正案をもとに、もしまだエラーが出る場合はUnityのエラーメッセージ全文を貼り付けてください。さらに深く調査・修正案を出します！**

---

