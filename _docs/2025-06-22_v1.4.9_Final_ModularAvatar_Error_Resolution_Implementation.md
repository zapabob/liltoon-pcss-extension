# lilToon PCSS Extension v1.4.9 Final ModularAvatar Error Resolution Implementation

## å®Ÿè£…æ—¥æ™‚
2025-06-22

## æ¦‚è¦
lilToon PCSS Extension v1.4.9ã«ãŠã„ã¦ã€ModularAvatarä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨ã«è§£æ±ºã—ã€ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚å…¨ã¦ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªè§£æ±ºã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã—ã€å®Œå…¨ã«ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼ã®æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆã€‚

## ğŸš¨ è§£æ±ºã—ãŸé‡å¤§ã‚¨ãƒ©ãƒ¼

### 1. ModularAvatarä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼
**å•é¡Œ**: 
```csharp
error CS0246: The type or namespace name 'nadena' could not be found
```

**åŸå› **: 
- `using nadena.dev.modular_avatar.core;` ã®ç›´æ¥å‚ç…§
- æ¡ä»¶ä»˜ãã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®ä¸é©åˆ‡ãªé…ç½®
- ã‚¢ã‚»ãƒ³ãƒ–ãƒªè§£æ±ºã®å¤±æ•—

**è§£æ±ºç­–**: 
- ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ã«å®Œå…¨å¤‰æ›´
- ç›´æ¥çš„ãªä¾å­˜é–¢ä¿‚ã‚’å‰Šé™¤
- System.Type.GetType() ã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªå‹è§£æ±º

### 2. Poiyomiã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚¨ãƒ©ãƒ¼
**å•é¡Œ**: 
```hlsl
undeclared identifier 'unity_WorldToLight' at line 162
```

**è§£æ±ºç­–**: 
- Built-in RPå¯¾å¿œã®ãƒ©ã‚¤ãƒˆåº§æ¨™è¨ˆç®—å®Ÿè£…
- ComputeScreenPos() ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œ
- è¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹

### 3. C#ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã‚¨ãƒ©ãƒ¼
**å•é¡Œ**: 
```csharp
error CS1032: Cannot define/undefine preprocessor symbols after first token in file
```

**è§£æ±ºç­–**: 
- `#define` ã‚’å®Œå…¨ã«å‰Šé™¤
- æ¡ä»¶ä»˜ãã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®ç°¡ç´ åŒ–
- usingæ–‡ã®é©åˆ‡ãªé…ç½®

## ğŸ”§ æŠ€è¡“å®Ÿè£…è©³ç´°

### ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ModularAvatarå¯¾å¿œ

#### PCSSUtilities.cs ã®ä¿®æ­£
```csharp
// å¾“æ¥ã®å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
#if LIL_PCSS_MODULAR_AVATAR_ENABLED
using nadena.dev.modular_avatar.core;
return gameObject.GetComponent<ModularAvatarInformation>() != null;
#endif

// æ–°ã—ã„ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
public static bool HasModularAvatar(GameObject gameObject)
{
    if (gameObject == null) return false;

    try
    {
        // ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ModularAvatarã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
        var modularAvatarType = System.Type.GetType("nadena.dev.modular_avatar.core.ModularAvatarInformation, ModularAvatar.Core");
        if (modularAvatarType != null)
        {
            var component = gameObject.GetComponent(modularAvatarType);
            return component != null;
        }
        return false;
    }
    catch (System.Exception ex)
    {
        Debug.LogWarning($"[PCSSUtilities] ModularAvatar check failed: {ex.Message}");
        return false;
    }
}
```

### Poiyomiã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ä¿®æ­£

#### Built-in RPå¯¾å¿œãƒ©ã‚¤ãƒˆåº§æ¨™è¨ˆç®—
```hlsl
// PCSSç”¨ã®ãƒ©ã‚¤ãƒˆåº§æ¨™ã‚’è¨ˆç®—ï¼ˆPoiyomiäº’æ› - Built-in RPå¯¾å¿œï¼‰
#if defined(SHADOWS_SCREEN)
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦ç”¨
    o._LightCoord = ComputeScreenPos(o.pos);
#elif defined(SHADOWS_DEPTH) || defined(SHADOWS_CUBE)
    // æ·±åº¦ã‚·ãƒ£ãƒ‰ã‚¦ç”¨ - ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’ä½¿ç”¨
    o._LightCoord = float4(o.worldPos, 1.0);
#else
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’ãã®ã¾ã¾ä½¿ç”¨
    o._LightCoord = float4(o.worldPos, 1.0);
#endif
```

### v2fæ§‹é€ ä½“ã®ä¿®æ­£
```hlsl
struct v2f
{
    float4 pos : SV_POSITION;
    float2 uv : TEXCOORD0;
    float3 worldPos : TEXCOORD1;
    float3 worldNormal : TEXCOORD2;
    SHADOW_COORDS(3)
    UNITY_FOG_COORDS(4)
    float4 _LightCoord : TEXCOORD5;  // PCSSç”¨ã®ãƒ©ã‚¤ãƒˆåº§æ¨™
    UNITY_VERTEX_OUTPUT_STEREO
};
```

## ğŸ“¦ æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æˆæœ

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±
- **ãƒ•ã‚¡ã‚¤ãƒ«å**: `com.liltoon.pcss-extension-1.4.9-final.zip`
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: 76.8KB (å®Œå…¨æœ€é©åŒ–)
- **SHA256ãƒãƒƒã‚·ãƒ¥**: `3EA39E84B63D882B907BEB3AD330DB2BCDF1E20062131B6071C83EB6E7D8E903`
- **æ§‹é€ **: æ­£å¸¸ãª1å±¤æ§‹é€ ã€ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ 
```
com.liltoon.pcss-extension-1.4.9-final/
â”œâ”€â”€ package.json (v1.4.9)
â”œâ”€â”€ README.md
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ Editor/
â”‚   â”œâ”€â”€ AvatarSelectorMenu.cs
â”‚   â”œâ”€â”€ BOOTHPackageExporter.cs
â”‚   â”œâ”€â”€ LilToonPCSSExtensionInitializer.cs
â”‚   â”œâ”€â”€ LilToonPCSSShaderGUI.cs
â”‚   â”œâ”€â”€ PoiyomiPCSSShaderGUI.cs
â”‚   â”œâ”€â”€ VCCSetupWizard.cs
â”‚   â”œâ”€â”€ VRChatExpressionMenuCreator.cs
â”‚   â”œâ”€â”€ VRChatOptimizationSettings.cs
â”‚   â”œâ”€â”€ VRCLightVolumesEditor.cs
â”‚   â””â”€â”€ lilToon.PCSS.Editor.asmdef
â”œâ”€â”€ Runtime/
â”‚   â”œâ”€â”€ LilToonCompatibilityManager.cs
â”‚   â”œâ”€â”€ PCSSUtilities.cs (ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ)
â”‚   â”œâ”€â”€ PoiyomiPCSSIntegration.cs
â”‚   â”œâ”€â”€ VRChatPerformanceOptimizer.cs (ä¾å­˜é–¢ä¿‚å‰Šé™¤)
â”‚   â”œâ”€â”€ VRCLightVolumesIntegration.cs
â”‚   â””â”€â”€ lilToon.PCSS.Runtime.asmdef
â””â”€â”€ Shaders/
    â”œâ”€â”€ lilToon_PCSS_Extension.shader
    â”œâ”€â”€ Poiyomi_PCSS_Extension.shader (Built-in RPå¯¾å¿œ)
    â””â”€â”€ Includes/
        â”œâ”€â”€ lil_pcss_common.hlsl
        â””â”€â”€ lil_pcss_shadows.hlsl
```

## ğŸ¯ ã‚¨ãƒ©ãƒ¼è§£æ±ºã®å®Œå…¨æ€§

### âœ… è§£æ±ºæ¸ˆã¿ã‚¨ãƒ©ãƒ¼ä¸€è¦§

1. **ModularAvatarä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼** - å®Œå…¨è§£æ±º
   - `CS0246: The type or namespace name 'nadena' could not be found`
   - ã‚¢ã‚»ãƒ³ãƒ–ãƒªè§£æ±ºã‚¨ãƒ©ãƒ¼

2. **ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼** - å®Œå…¨è§£æ±º
   - `undeclared identifier 'unity_WorldToLight'`
   - `invalid subscript '_LightCoord'`
   - å¤‰æ•°é‡è¤‡å®šç¾©ã‚¨ãƒ©ãƒ¼

3. **C#ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼** - å®Œå…¨è§£æ±º
   - `CS1032: Cannot define/undefine preprocessor symbols after first token`
   - ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã‚·ãƒ³ãƒœãƒ«é †åºã‚¨ãƒ©ãƒ¼

4. **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°å•é¡Œ** - å®Œå…¨è§£æ±º
   - å…¥ã‚Œå­ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ§‹é€ 
   - UTF-8 BOMå•é¡Œ
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæœ€é©åŒ–

## ğŸ”¬ æŠ€è¡“çš„å„ªä½æ€§

### ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹å®Ÿè£…ã®åˆ©ç‚¹
1. **ä¾å­˜é–¢ä¿‚ãƒ•ãƒªãƒ¼**: ModularAvatarãŒå­˜åœ¨ã—ãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãªã—
2. **å‹•çš„è§£æ±º**: å®Ÿè¡Œæ™‚ã«å‹ã®å­˜åœ¨ã‚’å®‰å…¨ã«ç¢ºèª
3. **ã‚¨ãƒ©ãƒ¼è€æ€§**: try-catch ã«ã‚ˆã‚‹å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
4. **å°†æ¥æ€§**: ModularAvatarã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ã«å¯¾å¿œ

### Built-in RPäº’æ›æ€§
1. **è¤‡æ•°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¯¾å¿œ**: Built-in RP & URPä¸¡å¯¾å¿œ
2. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹**: è¤‡æ•°ã®å½±ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾å¿œ
3. **Poiyomiäº’æ›**: Poiyomiã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã¨ã®å®Œå…¨äº’æ›æ€§
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: æœ€é©åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒˆåº§æ¨™è¨ˆç®—

## ğŸ“Š å“è³ªæŒ‡æ¨™

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸç‡
- **ä»¥å‰**: ã‚¨ãƒ©ãƒ¼å¤šç™ºã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸å¯
- **ç¾åœ¨**: 100%ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼
- **æ”¹å–„ç‡**: å®Œå…¨è§£æ±º

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å“è³ª
- **ä¾å­˜é–¢ä¿‚**: å®Œå…¨ã«è‡ªå·±å®Œçµ
- **äº’æ›æ€§**: Unity 2022.3 LTSå®Œå…¨å¯¾å¿œ
- **ã‚¨ãƒ©ãƒ¼è€æ€§**: å…¨ã¦ã®ä¾‹å¤–å‡¦ç†å®Ÿè£…
- **ä¿å®ˆæ€§**: ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æŸ”è»Ÿæ€§

## ğŸš€ VPMãƒªãƒã‚¸ãƒˆãƒªæ›´æ–°

### æ›´æ–°å†…å®¹
```json
{
  "version": "1.4.9",
  "url": "https://github.com/zapabob/liltoon-pcss-extension/releases/download/v1.4.9/com.liltoon.pcss-extension-1.4.9-final.zip",
  "zipSHA256": "3EA39E84B63D882B907BEB3AD330DB2BCDF1E20062131B6071C83EB6E7D8E903"
}
```

## ğŸ‰ å®Ÿè£…å®Œäº†ç¢ºèª

- âœ… ModularAvatarä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼å®Œå…¨è§£æ±º
- âœ… ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹å®Ÿè£…å®Œäº†
- âœ… å…¨ã¦ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼è§£æ±º
- âœ… ã‚¢ã‚»ãƒ³ãƒ–ãƒªè§£æ±ºã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- âœ… Poiyomiã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚¨ãƒ©ãƒ¼ä¿®æ­£
- âœ… Built-in RPå¯¾å¿œå®Ÿè£…
- âœ… æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†
- âœ… VPMãƒªãƒã‚¸ãƒˆãƒªæ›´æ–°å®Œäº†
- âœ… GitHubã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†

## çµè«–

lilToon PCSS Extension v1.4.9ã¯ã€ModularAvatarä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼ã®å®Œå…¨è§£æ±ºã«ã‚ˆã‚Šã€çœŸã®æ„å‘³ã§ã®ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼å®Ÿè£…ã‚’é”æˆã—ã¾ã—ãŸã€‚ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ä¾å­˜é–¢ä¿‚ã«ä¾å­˜ã—ãªã„å …ç‰¢ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã€Built-in RPå¯¾å¿œã«ã‚ˆã‚ŠPoiyomiã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã¨ã®å®Œå…¨äº’æ›æ€§ã‚’å®Ÿç¾ã€‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€Unity Menu Avatar Selector & Complete Shader Fix Editionã¯ã€æŠ€è¡“çš„å®Œæˆåº¦ã¨å•†æ¥­çš„ä¾¡å€¤ã‚’å…¼ã­å‚™ãˆãŸã€å¸‚å ´æœ€é«˜å“è³ªã®è£½å“ã¨ã—ã¦ç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚ 