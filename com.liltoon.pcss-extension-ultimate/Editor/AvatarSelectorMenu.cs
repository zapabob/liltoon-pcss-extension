using UnityEngine;
using UnityEditor;
using System.Collections.Generic;
using System.Linq;
#if VRCHAT_SDK_AVAILABLE
using VRC.SDK3.Avatars.Components;
#endif

namespace lilToon.PCSS.Editor
{
    /// <summary>
    /// „Ç¢„Éê„Çø„ÉºÈÅ∏Êäû„É°„Éã„É•„Éº„Ç∑„Çπ„ÉÜ„É†
    /// „Ç∑„Éº„É≥ÂÜÖ„ÅÆ„Ç¢„Éê„Çø„Éº„ÇíËá™ÂãïÊ§úÂá∫„Åó„Å¶ÈÅ∏Êäû„ÉªÂ∞éÂÖ•„Åß„Åç„Çã„É°„Éã„É•„Éº
    /// </summary>
    public class AvatarSelectorMenu : EditorWindow
    {
        private Vector2 scrollPosition;
        private List<AvatarInfo> availableAvatars = new List<AvatarInfo>();
        private AvatarInfo selectedAvatar;
        private SetupMode selectedSetupMode = SetupMode.CompetitorCompatible;
        private bool showAdvancedOptions = false;
        
        // UI „Çπ„Çø„Ç§„É´
        private GUIStyle headerStyle;
        private GUIStyle avatarButtonStyle;
        private GUIStyle selectedAvatarStyle;
        private GUIStyle setupButtonStyle;
        
        public enum SetupMode
        {
            CompetitorCompatible,
            ToonShadows,
            RealisticShadows,
            CustomSetup
        }
        
        [System.Serializable]
        public class AvatarInfo
        {
            public GameObject gameObject;
            public string name;
            public string path;
            public bool hasVRCAvatarDescriptor;
            public int rendererCount;
            public int materialCount;
            public Texture2D preview;
            
            public AvatarInfo(GameObject obj)
            {
                gameObject = obj;
                name = obj.name;
                path = GetGameObjectPath(obj);
                
#if VRCHAT_SDK_AVAILABLE
                hasVRCAvatarDescriptor = obj.GetComponent<VRCAvatarDescriptor>() != null;
#else
                hasVRCAvatarDescriptor = false;
#endif
                
                var renderers = obj.GetComponentsInChildren<Renderer>();
                rendererCount = renderers.Length;
                materialCount = renderers.SelectMany(r => r.sharedMaterials).Where(m => m != null).Distinct().Count();
            }
            
            private string GetGameObjectPath(GameObject obj)
            {
                string path = obj.name;
                Transform parent = obj.transform.parent;
                while (parent != null)
                {
                    path = parent.name + "/" + path;
                    parent = parent.parent;
                }
                return path;
            }
        }
        
        [MenuItem("Window/lilToon PCSS Extension/üéØ Avatar Selector")]
        public static void ShowWindow()
        {
            var window = GetWindow<AvatarSelectorMenu>("Avatar Selector");
            window.titleContent = new GUIContent("üéØ Avatar Selector", "„Ç¢„Éê„Çø„ÉºÈÅ∏Êäû„É°„Éã„É•„Éº");
            window.minSize = new Vector2(500, 400);
            window.Show();
        }
        
        [MenuItem("lilToon PCSS Extension/üéØ Avatar Selector", false, 1)]
        public static void ShowWindowFromMenu()
        {
            ShowWindow();
        }
        
        private void OnEnable()
        {
            RefreshAvatarList();
            InitializeStyles();
        }
        
        private void OnFocus()
        {
            RefreshAvatarList();
        }
        
        private void InitializeStyles()
        {
            headerStyle = new GUIStyle(EditorStyles.boldLabel)
            {
                fontSize = 16,
                alignment = TextAnchor.MiddleCenter,
                normal = { textColor = new Color(0.8f, 0.8f, 1f) }
            };
            
            avatarButtonStyle = new GUIStyle(GUI.skin.button)
            {
                alignment = TextAnchor.MiddleLeft,
                fontSize = 11,
                fixedHeight = 60,
                padding = new RectOffset(10, 10, 5, 5)
            };
            
            selectedAvatarStyle = new GUIStyle(avatarButtonStyle)
            {
                normal = { background = MakeTexture(2, 2, new Color(0.3f, 0.6f, 1f, 0.3f)) }
            };
            
            setupButtonStyle = new GUIStyle(GUI.skin.button)
            {
                fontSize = 12,
                fixedHeight = 35,
                fontStyle = FontStyle.Bold
            };
        }
        
        private Texture2D MakeTexture(int width, int height, Color color)
        {
            Color[] pix = new Color[width * height];
            for (int i = 0; i < pix.Length; i++)
                pix[i] = color;
            
            Texture2D result = new Texture2D(width, height);
            result.SetPixels(pix);
            result.Apply();
            return result;
        }
        
        private void OnGUI()
        {
            if (headerStyle == null) InitializeStyles();
            
            DrawHeader();
            DrawAvatarList();
            DrawSetupOptions();
            DrawActionButtons();
        }
        
        private void DrawHeader()
        {
            EditorGUILayout.Space(10);
            EditorGUILayout.LabelField("üéØ lilToon PCSS Extension", headerStyle);
            EditorGUILayout.LabelField("Avatar Selector & Setup System", EditorStyles.centeredGreyMiniLabel);
            EditorGUILayout.Space(10);
            
            EditorGUILayout.BeginHorizontal();
            if (GUILayout.Button("üîÑ Refresh Avatar List", GUILayout.Height(25)))
            {
                RefreshAvatarList();
            }
            if (GUILayout.Button("üìñ Help", GUILayout.Height(25), GUILayout.Width(60)))
            {
                Application.OpenURL("https://zapabob.github.io/liltoon-pcss-extension/documentation.html");
            }
            EditorGUILayout.EndHorizontal();
            
            EditorGUILayout.Space(5);
        }
        
        private void DrawAvatarList()
        {
            EditorGUILayout.LabelField($"Available Avatars ({availableAvatars.Count})", EditorStyles.boldLabel);
            
            if (availableAvatars.Count == 0)
            {
                EditorGUILayout.HelpBox("No avatars found in the scene. Please add VRChat avatars to the scene.", MessageType.Info);
                return;
            }
            
            scrollPosition = EditorGUILayout.BeginScrollView(scrollPosition, GUILayout.Height(200));
            
            foreach (var avatar in availableAvatars)
            {
                DrawAvatarButton(avatar);
            }
            
            EditorGUILayout.EndScrollView();
        }
        
        private void DrawAvatarButton(AvatarInfo avatar)
        {
            var style = (selectedAvatar == avatar) ? selectedAvatarStyle : avatarButtonStyle;
            
            EditorGUILayout.BeginHorizontal();
            
            if (GUILayout.Button("", style, GUILayout.Height(60)))
            {
                selectedAvatar = avatar;
                Selection.activeGameObject = avatar.gameObject;
                SceneView.FrameLastActiveSceneView();
            }
            
            var buttonRect = GUILayoutUtility.GetLastRect();
            
            // „Ç¢„Éê„Çø„ÉºÊÉÖÂ†±„ÇíÊèèÁîª
            var contentRect = new Rect(buttonRect.x + 10, buttonRect.y + 5, buttonRect.width - 20, buttonRect.height - 10);
            
            GUI.Label(new Rect(contentRect.x, contentRect.y, contentRect.width, 16), 
                $"üé≠ {avatar.name}", EditorStyles.boldLabel);
            
            GUI.Label(new Rect(contentRect.x, contentRect.y + 18, contentRect.width, 14), 
                $"Path: {avatar.path}", EditorStyles.miniLabel);
            
            var statusText = avatar.hasVRCAvatarDescriptor ? "‚úÖ VRChat Avatar" : "‚ö†Ô∏è No VRCAvatarDescriptor";
            var statusColor = avatar.hasVRCAvatarDescriptor ? Color.green : Color.yellow;
            
            var oldColor = GUI.color;
            GUI.color = statusColor;
            GUI.Label(new Rect(contentRect.x, contentRect.y + 32, contentRect.width / 2, 14), 
                statusText, EditorStyles.miniLabel);
            GUI.color = oldColor;
            
            GUI.Label(new Rect(contentRect.x + contentRect.width / 2, contentRect.y + 32, contentRect.width / 2, 14), 
                $"Renderers: {avatar.rendererCount} | Materials: {avatar.materialCount}", EditorStyles.miniLabel);
            
            // ÈÅ∏Êäû„Éú„Çø„É≥
            if (GUI.Button(new Rect(buttonRect.x + buttonRect.width - 80, buttonRect.y + 5, 70, 20), "Select"))
            {
                selectedAvatar = avatar;
                Selection.activeGameObject = avatar.gameObject;
                SceneView.FrameLastActiveSceneView();
            }
            
            EditorGUILayout.EndHorizontal();
            EditorGUILayout.Space(2);
        }
        
        private void DrawSetupOptions()
        {
            EditorGUILayout.Space(10);
            EditorGUILayout.LabelField("Setup Options", EditorStyles.boldLabel);
            
            selectedSetupMode = (SetupMode)EditorGUILayout.EnumPopup("Setup Mode", selectedSetupMode);
            
            // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„É¢„Éº„Éâ„ÅÆË™¨Êòé
            string description = GetSetupModeDescription(selectedSetupMode);
            EditorGUILayout.HelpBox(description, MessageType.Info);
            
            showAdvancedOptions = EditorGUILayout.Foldout(showAdvancedOptions, "Advanced Options");
            if (showAdvancedOptions)
            {
                EditorGUI.indentLevel++;
                EditorGUILayout.LabelField("Advanced options will be available in future updates.", EditorStyles.miniLabel);
                EditorGUI.indentLevel--;
            }
        }
        
        private string GetSetupModeDescription(SetupMode mode)
        {
            switch (mode)
            {
                case SetupMode.CompetitorCompatible:
                    return "üéØ Á´∂ÂêàË£ΩÂìÅ‰∫íÊèõ„É¢„Éº„Éâ: nHarukaÁ≠â„ÅÆÁ´∂ÂêàË£ΩÂìÅ„Å®ÂêåÁ≠â„ÅÆÊ©üËÉΩ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇPhysBoneÈÄ£Âãï„ÄÅ10mË∑ùÈõ¢Âà∂Âæ°„ÄÅ„Ç∑„É£„Éâ„Ç¶„Éû„Çπ„ÇØÊ©üËÉΩ„ÇíÂê´„Åø„Åæ„Åô„ÄÇ";
                case SetupMode.ToonShadows:
                    return "üé≠ „Éà„Ç•„Éº„É≥ÂΩ±„É¢„Éº„Éâ: „Ç¢„Éã„É°Ë™ø„ÅÆÁæé„Åó„ÅÑÂΩ±Â¢ÉÁïåÁ∑ö„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇVTuber„Ç¢„Éê„Çø„Éº„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüË®≠ÂÆö„Åß„Åô„ÄÇ";
                case SetupMode.RealisticShadows:
                    return "üì∏ „É™„Ç¢„É´ÂΩ±„É¢„Éº„Éâ: ÂÜôÂÆüÁöÑ„Å™ÂΩ±Ë°®Áèæ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ„É™„Ç¢„É´„Å™„Ç¢„Éê„Çø„Éº„ÇÑÂÜôÁúüÊíÆÂΩ±„Å´ÈÅ©„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ";
                case SetupMode.CustomSetup:
                    return "‚öôÔ∏è „Ç´„Çπ„Çø„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó: Ë©≥Á¥∞Ë®≠ÂÆö„Ç¶„Ç£„Ç∂„Éº„Éâ„ÇíÈñã„ÅÑ„Å¶„ÄÅÂÄãÂà•„Å´„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åß„Åç„Åæ„Åô„ÄÇ";
                default:
                    return "";
            }
        }
        
        private void DrawActionButtons()
        {
            EditorGUILayout.Space(10);
            
            GUI.enabled = selectedAvatar != null;
            
            EditorGUILayout.BeginHorizontal();
            
            if (GUILayout.Button($"üöÄ Setup Selected Avatar", setupButtonStyle))
            {
                ExecuteSetup();
            }
            
            if (GUILayout.Button("üîß Open Setup Wizard", GUILayout.Height(35)))
            {
                if (selectedSetupMode == SetupMode.CustomSetup)
                {
                    CompetitorCompatibleSetupWizard.ShowWindow();
                }
                else
                {
                    VCCSetupWizard.ShowWindow();
                }
            }
            
            EditorGUILayout.EndHorizontal();
            
            GUI.enabled = true;
            
            if (selectedAvatar == null)
            {
                EditorGUILayout.HelpBox("Please select an avatar to proceed with setup.", MessageType.Warning);
            }
            else if (!selectedAvatar.hasVRCAvatarDescriptor)
            {
                EditorGUILayout.HelpBox("Selected object is not a VRChat avatar. VRCAvatarDescriptor component is required.", MessageType.Warning);
            }
        }
        
        private void ExecuteSetup()
        {
            if (selectedAvatar == null) return;
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Ç¢„Éê„Çø„Éº„ÇíUnity„ÅÆSelection„Å´Ë®≠ÂÆö
            Selection.activeGameObject = selectedAvatar.gameObject;
            
            switch (selectedSetupMode)
            {
                case SetupMode.CompetitorCompatible:
                    OneClickSetupMenu.QuickSetupCompetitorCompatible(selectedAvatar.gameObject);
                    break;
                case SetupMode.ToonShadows:
                    OneClickSetupMenu.QuickSetupToonShadows(selectedAvatar.gameObject);
                    break;
                case SetupMode.RealisticShadows:
                    OneClickSetupMenu.QuickSetupRealisticShadows(selectedAvatar.gameObject);
                    break;
                case SetupMode.CustomSetup:
                    OneClickSetupMenu.OpenCustomSetupWizard();
                    break;
            }
        }
        
        private void RefreshAvatarList()
        {
            availableAvatars.Clear();
            
            // „Ç∑„Éº„É≥ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆGameObject„ÇíÊ§úÁ¥¢
            var allObjects = FindObjectsOfType<GameObject>();
            
            foreach (var obj in allObjects)
            {
                // „É´„Éº„Éà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„Åø„ÇíÂØæË±°„Å®„Åô„Çã
                if (obj.transform.parent == null)
                {
                    // VRCAvatarDescriptor„ÇíÊåÅ„Å§„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂÑ™ÂÖà
#if VRCHAT_SDK_AVAILABLE
                    if (obj.GetComponent<VRCAvatarDescriptor>() != null)
                    {
                        availableAvatars.Add(new AvatarInfo(obj));
                        continue;
                    }
#endif
                    
                    // Â≠ê„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´VRCAvatarDescriptor„Åå„ÅÇ„ÇãÂ†¥Âêà„ÇÇÂê´„ÇÅ„Çã
#if VRCHAT_SDK_AVAILABLE
                    if (obj.GetComponentInChildren<VRCAvatarDescriptor>() != null)
                    {
                        availableAvatars.Add(new AvatarInfo(obj));
                        continue;
                    }
#endif
                    
                    // Renderer„ÇíÊåÅ„Å§„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÂÄôË£ú„Å®„Åó„Å¶ËøΩÂä†Ôºà„Ç¢„Éê„Çø„Éº„ÅÆÂèØËÉΩÊÄßÔºâ
                    if (obj.GetComponentsInChildren<Renderer>().Length > 0)
                    {
                        availableAvatars.Add(new AvatarInfo(obj));
                    }
                }
            }
            
            // VRCAvatarDescriptor„ÇíÊåÅ„Å§„ÇÇ„ÅÆ„ÇíÂÑ™ÂÖà„Åó„Å¶„ÇΩ„Éº„Éà
            availableAvatars = availableAvatars.OrderByDescending(a => a.hasVRCAvatarDescriptor)
                                             .ThenBy(a => a.name)
                                             .ToList();
        }
    }
} 